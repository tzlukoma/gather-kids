ðŸ”§ Setting up test database...
   Using database: postgresql://postgres:postgres@127.0.0.1:54322/postgres
âœ… Supabase CLI found
ðŸ”„ Resetting test database...
Resetting local database...
Recreating database...
Initialising schema...
Seeding globals from roles.sql...
Applying migration 0001_init.sql...
NOTICE (42710): extension "pgcrypto" already exists, skipping
Applying migration 0002_add_households_children.sql...
Applying migration 0003_add_columns_for_import.sql...
NOTICE (42701): column "mobile_phone" of relation "guardians" already exists, skipping
Applying migration 0004_ids_to_text.sql...
NOTICE (00000): relation "emergency_contacts" does not exist, skipping
NOTICE (00000): constraint "fk_guardians_household" of relation "guardians" does not exist, skipping
Applying migration 0005_uuid_surrogates.sql...
NOTICE (42710): extension "pgcrypto" already exists, skipping
Applying migration 0006_add_external_id_columns.sql...
Applying migration 0007_allow_nullable_household_id.sql...
Applying migration 0008_add_children_extra_columns.sql...
NOTICE (42701): column "updated_at" of relation "children" already exists, skipping
Applying migration 0009_add_events_attendance.sql...
Applying migration 0010_add_timeslots_to_events.sql...
Applying migration 0011_add_registrations_related.sql...
Applying migration 0012_add_ministry_enrollments_custom_fields.sql...
Applying migration 0013_add_emergency_contacts.sql...
Applying migration 0014_create_users.sql...
Applying migration 0015_add_competition_years.sql...
Applying migration 0016_add_incidents.sql...
Applying migration 0017_add_scriptures_external_id.sql...
Applying migration 0018_add_updated_at_to_scriptures.sql...
Applying migration 0019_add_grade_rules.sql...
Applying migration 0020_add_student_scriptures.sql...
Applying migration 0021_add_student_essays.sql...
Applying migration 0022_add_emergency_contacts_household_uuid.sql...
Applying migration 0023_add_student_scriptures_scripture_uuid.sql...
Applying migration 0024_add_guardians_household_uuid.sql...
Applying migration 0025_add_missing_tables.sql...
Applying migration 0026_fix_children_household_id.sql...
NOTICE (42P07): relation "households" already exists, skipping
NOTICE (42P07): relation "children" already exists, skipping
NOTICE (00000): children.household_id column already exists or table was just created
NOTICE (00000): Foreign key constraint already exists or could not be added
Applying migration 10000_safe_apply_schema.sql...
NOTICE (42P07): relation "households" already exists, skipping
NOTICE (42P07): relation "guardians" already exists, skipping
NOTICE (42P07): relation "children" already exists, skipping
NOTICE (00000): FK constraint guardians_household_id_fkey already exists, skipping
NOTICE (00000): FK constraint children_household_id_fkey already exists, skipping
Applying migration 20250828174806_0001_init.sql...
NOTICE (42710): extension "pgcrypto" already exists, skipping
NOTICE (42P07): relation "scriptures" already exists, skipping
Applying migration 20250902000000_migration_safety_functions.sql...
Applying migration 20250902000001_simple_fix_household_id.sql...
NOTICE (42P07): relation "children" already exists, skipping
NOTICE (00000): No default found on children.household_id, nothing to drop
Applying migration 20250902000002_fix_household_id_default.sql...
NOTICE (42P07): relation "children" already exists, skipping
NOTICE (00000): No default found on children.household_id, nothing to drop
Applying migration 20250902000003_initial_safety.sql...
NOTICE (42P07): relation "households" already exists, skipping
NOTICE (42P07): relation "guardians" already exists, skipping
NOTICE (42P07): relation "children" already exists, skipping
Applying migration 20250902000004_safe_defaults.sql...
NOTICE (00000): Dropped default for guardians.household_id
NOTICE (00000): Dropped default for children.household_id
NOTICE (00000): Dropped default for guardians.guardian_id
NOTICE (00000): Dropped default for children.child_id
NOTICE (00000): Dropped default for households.household_id
Applying migration 20250902000005_safe_ids_to_text.sql...
NOTICE (00000): Dropped constraint guardians_household_id_fkey from table guardians
NOTICE (00000): Dropped constraint children_household_id_fkey from table children
NOTICE (00000): Dropped constraint fk_emergency_contacts_household from table emergency_contacts
NOTICE (00000): Dropped constraint fk_guardians_household from table guardians
NOTICE (00000): Dropped default for guardians.household_id
NOTICE (00000): Dropped default for children.household_id
NOTICE (00000): Dropped default for guardians.guardian_id
NOTICE (00000): Dropped default for children.child_id
NOTICE (00000): Dropped default for households.household_id
NOTICE (00000): Changed type of households.household_id to text
NOTICE (00000): Changed type of guardians.household_id to text
NOTICE (00000): Changed type of children.household_id to text
NOTICE (00000): Changed type of guardians.guardian_id to text
NOTICE (00000): Changed type of children.child_id to text
Applying migration 20250902000006_direct_fix_household.sql...
NOTICE (42P07): relation "children" already exists, skipping
NOTICE (00000): Successfully dropped default from children.household_id
Applying migration 20250902000010_safe_household_structure.sql...
NOTICE (42P07): relation "households" already exists, skipping
NOTICE (00000): Added foreign key constraint children_household_id_fkey
NOTICE (00000): Added foreign key constraint guardians_household_id_fkey
NOTICE (00000): Added foreign key constraint fk_emergency_contacts_household
Applying migration 20250902211500_fix_emergency_contacts_fk.sql...
NOTICE (00000): Found 0 emergency contacts with invalid household references
NOTICE (00000): Set 0 invalid references to NULL
NOTICE (00000): Updated 0 emergency contacts with matching external IDs
NOTICE (00000): Converted household_id_uuid to UUID type
Applying migration 20250903000001_add_leader_tables.sql...
NOTICE (42P07): relation "leader_assignments" already exists, skipping
Applying migration 20250903011653_fix_branding_settings_schema.sql...
Applying migration 20250903110000_add_bible_bee_tables.sql...
NOTICE (42P07): relation "divisions" already exists, skipping
NOTICE (42P07): relation "essay_prompts" already exists, skipping
NOTICE (42P07): relation "enrollment_overrides" already exists, skipping
Applying migration 20250903213003_add_ministries_external_id.sql...
Applying migration 20250904010000_fix_scriptures_competition_year_id_type.sql...
NOTICE (00000): Converting scriptures.competition_year_id from uuid to text
NOTICE (00000): Successfully converted scriptures.competition_year_id to text type
Applying migration 20250904165756_add_scripture_fields.sql...
NOTICE (00000): Adding missing fields to scriptures table
NOTICE (00000): Added scripture_number column
NOTICE (00000): Added scripture_order column
NOTICE (00000): Added counts_for column
NOTICE (00000): Added category column
NOTICE (00000): Successfully added missing scripture fields
Applying migration 20250904171806_add_missing_attendance_fields.sql...
Applying migration 20250905001727_add_household_address_fields.sql...
Applying migration 20250905005600_fix_registration_schema_mismatches.sql...
NOTICE (42701): column "grade" of relation "children" already exists, skipping
NOTICE (42701): column "special_needs" of relation "children" already exists, skipping
NOTICE (42701): column "child_mobile" of relation "children" already exists, skipping
NOTICE (42701): column "relationship" of relation "guardians" already exists, skipping
Applying migration 20250905040649_registration_schema_normalize.sql...
NOTICE (00000): Households: Updated timestamp columns to timestamptz with defaults
NOTICE (00000): Children: Updated timestamp columns and is_active default
NOTICE (00000): Guardians: Updated timestamp columns to timestamptz with defaults
NOTICE (00000): Emergency Contacts: Updated timestamp columns to timestamptz with defaults
NOTICE (00000): Registrations: Updated consents to jsonb and normalized timestamps
Applying migration 20250905040720_registration_schema_backfill.sql...
NOTICE (00000): Households: Backfilled 0 rows for preferred_scripture_translation
NOTICE (00000): Children: Backfilled 0 rows for dob, 0 rows for child_mobile
NOTICE (00000): Registrations: Updated 0 rows to convert photoRelease -> photo_release
NOTICE (00000): Backfill Summary:
NOTICE (00000):   - Households with preferred_scripture_translation: 0
NOTICE (00000):   - Children with dob: 0
NOTICE (00000):   - Children with child_mobile: 0
NOTICE (00000):   - Remaining photoRelease consents (should be 0): 0
Applying migration 20250905040748_registration_schema_fk_hardening.sql...
NOTICE (00000): Guardians: Mapped 0 guardians from household_uuid to household_id
NOTICE (00000): Children: Mapped 0 children from household_uuid to household_id
NOTICE (00000): Emergency Contacts: Added FK constraint to households
NOTICE (00000): FK Integrity Check:
NOTICE (00000):   - Orphaned guardians: 0 (should be 0)
NOTICE (00000):   - Orphaned children: 0 (should be 0)
NOTICE (00000):   - Orphaned emergency contacts: 0 (should be 0)
Applying migration 20250905040834_registration_schema_drop_legacy.sql...
NOTICE (00000): Safety check passed: All legacy data has been backfilled to canonical columns
NOTICE (00000): Households: Dropped legacy column preferredScriptureTranslation
NOTICE (00000): Children: Dropped legacy column birth_date
NOTICE (00000): Children: Dropped legacy column mobile_phone
NOTICE (00000): Schema Validation:
NOTICE (00000):   - Households canonical: t
NOTICE (00000):   - Children canonical: t
NOTICE (00000):   - Registrations consents is jsonb: t
NOTICE (00000): SUCCESS: Registration domain schema is now fully canonical (snake_case)
Applying migration 9999_squashed_schema.sql...
NOTICE (42710): extension "pgcrypto" already exists, skipping
NOTICE (42P07): relation "households" already exists, skipping
NOTICE (42P07): relation "guardians" already exists, skipping
NOTICE (42P07): relation "children" already exists, skipping
NOTICE (42P07): relation "emergency_contacts" already exists, skipping
NOTICE (42P07): relation "users" already exists, skipping
NOTICE (42P07): relation "competition_years" already exists, skipping
NOTICE (42P07): relation "ministries" already exists, skipping
NOTICE (42P07): relation "registrations" already exists, skipping
NOTICE (42P07): relation "ministry_enrollments" already exists, skipping
NOTICE (42P07): relation "leader_assignments" already exists, skipping
NOTICE (42P07): relation "events" already exists, skipping
NOTICE (42P07): relation "attendance" already exists, skipping
NOTICE (42P07): relation "incidents" already exists, skipping
NOTICE (42P07): relation "scriptures" already exists, skipping
NOTICE (42P07): relation "grade_rules" already exists, skipping
NOTICE (42P07): relation "student_scriptures" already exists, skipping
NOTICE (42P07): relation "student_essays" already exists, skipping
WARN: no files matched pattern: supabase/seed.sql
Restarting containers...
Finished supabase db reset on branch copilot/fix-118.
âœ… Test database setup complete
âœ… Test database environment ready
   DATABASE_URL exported for tests
